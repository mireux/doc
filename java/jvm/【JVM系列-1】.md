## 【JVM系列-1】 JVM内存结构



## 一、什么是JVM？

JVM是Java Virtual Machine（Java虚拟机）的缩写，引入Java语言虚拟机后，Java语言在不同平台上运行时不需要重新编译。Java语言使用Java虚拟机屏蔽了与具体平台相关的信息，使得Java语言编译程序只需生成在Java虚拟机上运行的目标代码（字节码），就可以在多种平台上不加修改地运行。也就是“一次编译，到处运行”的理念。

## 二、JVM的内存结构

![jvm结构](http://badwomen.asia/jvm结构.png)

JVM的内存结构主要由五个部分组成：方法区(Method Area)、堆(Heap)、虚拟机栈(JVM Stack)、程序计数器(PC Register)、本地方法栈(Native Method Stacks)

## 1.程序计数器

程序计数器是一块较小的内存空间，它可以看作是当前线程执行的字节码的行号指示器。

**作用：**

程序计数器最大的作用就是记住一下条JVM指令的执行地址。用寄存器存放。字节码通过改变整个计数器的值来选取下一条执行的字节码指令。分支、循环、跳转、控制、异常处理、线程恢复等基础功能都需要依赖整个计数器来完成。

**特点：**

- 线程私有
- 唯一一个不会出现OOM(Out Of Memory)错误的区域

## 2.Java虚拟机栈

虚拟机栈的生命周期与线程同步。线程创建，虚拟机栈创建；线程死亡，虚拟机栈就死亡。虚拟机栈描述的是Java方法执行的线程内存模型。每个方法被执行的时候Java虚拟机栈都会同步的创建一个栈帧，用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法被调用直至完成的过程，相当于一个栈帧在虚拟机栈入栈到出栈的过程。每个线程只能有一个活动栈帧，对应着执行的哪个方法。

**局部变量表：**

存放了编译期间可知的各种Java虚拟机基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（reference类型，并不等同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是指向一个代表对象的句柄或者其他于此对象相关的位置）、和returnAddress类型（指向了一条字节码指令）。

这些数据类型在局部变量表中的存储空间以局部变量槽slot表示。其中64位长度的long和double类型的数据会占用2两个变量槽，其余的数据类型只占1个。局部变量表所需要的空间在编译期已经确定，方法运行期间完全不会改变大小（这里指的是槽的大小，而一个变量槽到底多大，完全由具体的JVM虚拟机实现）。

**栈内存溢出**

- 栈帧过多或者栈帧过大，会抛出StackOverflowError
- JVM容量可以动态伸展，当栈扩展到无法申请到足够的内存时会抛出OOM异常。
  虚拟机栈也是线程私有的。