# 前言

写这章的时候才发现好像没做上传图片……但其实加载图片是一种很直观的表达方式，也是一种偷懒的方式。也就当如何给面试官复数这些图片内容。毕竟你面试时也不能甩一张图片给面试官。

# Redis复习(2)

## 主从复制

**概念：**

主从复制就是将数据从一台redis服务器复制到其他redis服务器上。前者称之为主节点，后者称之为从节点。数据的复制是单向的。只能从主节点辅助到从节点。Master以写为主，Slave以读为主。

默认情况下，每台Redis服务器都是主节点，且一个主节点可以有多个从节点或者没有从节点，但是一个从节点只有一个主节点



**作用：**

1. 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余的方式。
2. 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复，实际上也是一种服务的冗余。
3. 负载均衡：在主从复制的基础上，配合读写分离，主节点只写，从节点只读（即写Redis数据时应用链接主节点，读Redis的时候应用链接从节点），分担服务器的负载，可以大大提高redis的并发量。
4. 集群的基石：主从复制是哨兵模式和集群能够实施的基础。

## 复制工作流程

主从复制过程大体分为三个阶段

- 建立连接阶段 
- 数据同步阶段
- 命令传播阶段

1. 首先是主机发送命令：ping，判断是否已经连接上从机，建立连接
2. master接受命令，判断从机的offset是否在复制缓冲区。如果不在缓冲区，执行全量复制。
3. 如果在缓冲区中，且主机的offset和从机的offset相同，忽略
4. 如果在缓冲区，且主机的offset和从机的offset不同，发送+CONTINUE offset 通过socket发送复制缓冲区从机的offset到主机的offset的数据
5. 从机收到+CONTINUE 保存主机的offset，接收到信息后，执行bgrewrite，恢复数据

### 复制原理

**Slave 启动成功连接到Master会发送一个sync同步命令**

主机接收到命令后，启动后台的存盘程序。同时收集所有接收到的用于修改数据集的命令，在后台进程执行完毕后，主机将传送整个数据文件到从机。并完成一次完全同步。

其中同步的数据使用的是RDB文件，收到同步命令后，主机会运行bgsave命令。把数据保存在rdb文件中发送给从机。

其中有两种复制方式：全量复制和增量复制。

**全量复制：**Slave 服务在接受到数据库文件后，将其存盘并加载到内存中

**增量复制：** 将主机执行bgsave操作中，新加入的数据（复制缓冲区中的数据）传给slave，从机通过bgrewriteaof指令来恢复数据

只要重新连接master，一次全量复制就自动执行。我们的数据一定可以在从机看见。

##### 复制缓冲区

- 概念：复制缓冲区，又名复制积压缓冲区，是一个**先进先出（FIFO）的队列**，用于存储服务器执行过的命令，每次传播命令，master都会将传播的命令记录下来，并存储在复制缓冲区
- 由来：每台服务器启动时，如果开启有AOF或被连接成为master节点，即创建复制缓冲区
- 作用：用于保存master收到的所有指令（仅影响数据变更的指令，例如set，select）
- 数据来源：当master接收到主客户端的指令时，除了将指令执行，会将该指令存储到缓冲区中

##### 复制缓冲区内部工作原理

- 组成
  - 偏移量
  - 字节值
- 工作原理
  - 通过offset区分不同的slave当前数据传播的差异
  - master记录**已发送**的信息对应的offset
  - slave记录**已接收**的信息对应的offset

通过offset去**同步信息**，比对master与slave的差异，当slave断线后，恢复数据使用

**第二种模式**

当slave过多时，建议调整结构，由一主多从结构变为树结构。中间的节点既是master，也是 slave。但这种当树高度不断增加，数据的一致性会逐渐变差。数据具有延时性。



# 哨兵模式

哨兵模式可以后台监控redis服务器是否故障，如果发生故障则通过投票机制选举出新的主机并将所有的从机连接到新的主机。

哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，他独立运行。其原理是**哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例**

**作用：**

1. 不断的检查master和slave是否正常运行。 master存活检测、master与slave运行情况检测
2. 当哨兵检测到master宕机，会自动将slave切换为master，然后通过发布订阅模式通知其他的从放服务器，修改配置文件，让他们切换主机。

然而一个哨兵进程对redis服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会监控，这就形成了多哨兵模式，但多为单数，为了方便当主机宕机时进行投票选举。

- 当某个哨兵发现主服务器挂掉了，会将master中的SentinelRedistance中的master改为**SRI_S_DOWN**（主观下线），并通知其他哨兵，告诉他们发现master挂掉了。
- 其他哨兵在接收到该哨兵发送的信息后，也会尝试去连接master，如果超过半数（配置文件中设置的）确认master挂掉后，会将master中的SentinelRedistance中的master改为**SRI_O_DOWN**（客观下线）

在之后哨兵就会进行一次投票选举，进行failover【故障转移】,切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现主从切换。